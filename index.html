<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼†ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        /* åˆæœŸç”»é¢ */
        .initial-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 600px;
        }

        .action-button {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .action-button:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .action-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            display: none;
        }

        .action-button .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .action-button .label {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }

        /* ãƒˆãƒªãƒŸãƒ³ã‚°ç”»é¢ */
        .cropping-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            z-index: 1000;
        }

        .cropping-container {
            height: calc(100% - 100px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .cropping-image {
            max-width: 100%;
            max-height: 100%;
        }

        .cropping-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .aspect-buttons {
            display: flex;
            gap: 10px;
        }

        .aspect-button {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .aspect-button:hover {
            background: #444;
        }

        .aspect-button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .control-button {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .control-button.primary {
            background: #4CAF50;
            color: white;
        }

        .control-button.primary:hover {
            background: #45a049;
        }

        .control-button.secondary {
            background: #666;
            color: white;
        }

        .control-button.secondary:hover {
            background: #555;
        }

        /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”»é¢ */
        .export-screen {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .preview-container {
            margin-bottom: 30px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        .preview-image {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
        }

        .export-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .export-button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .export-button.download {
            background: #2196F3;
            color: white;
        }

        .export-button.download:hover {
            background: #1976D2;
        }

        .export-button.clipboard {
            background: #FF9800;
            color: white;
        }

        .export-button.clipboard:hover {
            background: #F57C00;
        }

        .export-button.reset {
            background: #666;
            color: white;
        }

        .export-button.reset:hover {
            background: #555;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 3000;
        }

        .toast.show {
            opacity: 1;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› */
        .file-input {
            display: none;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .cropping-controls {
                flex-direction: column;
                gap: 15px;
            }

            .aspect-buttons {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼†ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ„ãƒ¼ãƒ«</h1>
            <p>ç”»åƒã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ã€ãŠå¥½ã¿ã®ã‚µã‚¤ã‚ºã«ãƒˆãƒªãƒŸãƒ³ã‚°ã§ãã¾ã™</p>
        </div>

        <!-- åˆæœŸç”»é¢ -->
        <div class="initial-screen" id="initialScreen">
            <div class="action-buttons">
                <div class="action-button" id="screenshotBtn">
                    <div class="icon">ğŸ“¸</div>
                    <div class="label">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚‹</div>
                </div>

                <div class="action-button" id="uploadBtn">
                    <div class="icon">ğŸ“</div>
                    <div class="label">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                </div>

                <div class="action-button" id="pasteBtn">
                    <div class="icon">ğŸ“‹</div>
                    <div class="label">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘</div>
                </div>

                <div class="action-button" id="cameraBtn">
                    <div class="icon">ğŸ“·</div>
                    <div class="label">ã‚«ãƒ¡ãƒ©ã§æ’®å½±</div>
                </div>
            </div>
        </div>

        <!-- ãƒˆãƒªãƒŸãƒ³ã‚°ç”»é¢ -->
        <div class="cropping-screen" id="croppingScreen">
            <div class="cropping-container">
                <img class="cropping-image" id="croppingImage">
            </div>
            <div class="cropping-controls">
                <div class="aspect-buttons">
                    <button class="aspect-button" data-ratio="1.7777">16:9</button>
                    <button class="aspect-button" data-ratio="1.3333">4:3</button>
                    <button class="aspect-button" data-ratio="1">1:1</button>
                    <button class="aspect-button active" data-ratio="NaN">è‡ªç”±</button>
                </div>
                <div>
                    <button class="control-button primary" id="cropConfirmBtn">æ±ºå®š</button>
                    <button class="control-button secondary" id="cropCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>

        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”»é¢ -->
        <div class="export-screen" id="exportScreen">
            <div class="preview-container">
                <img class="preview-image" id="previewImage">
            </div>
            <div class="export-actions">
                <button class="export-button download" id="downloadBtn">
                    <span>ğŸ’¾</span>
                    <span>ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                </button>
                <button class="export-button clipboard" id="clipboardBtn">
                    <span>ğŸ“‹</span>
                    <span>ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</span>
                </button>
                <button class="export-button reset" id="resetBtn">
                    <span>ğŸ”„</span>
                    <span>æ–°ã—ã„ç”»åƒã‚’èª­ã¿è¾¼ã‚€</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
    <div class="toast" id="toast"></div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
    <input type="file" accept="image/*" class="file-input" id="fileInput">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ç®¡ç†
        const App = {
            state: 'initial',
            currentImage: null,
            cropper: null,
            croppedCanvas: null,

            // åˆæœŸåŒ–
            init() {
                this.setupEventListeners();
                this.checkFeatureSupport();
            },

            // æ©Ÿèƒ½ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
            checkFeatureSupport() {
                // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ã¿ï¼‰
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile || !navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                    document.getElementById('screenshotBtn').classList.add('disabled');
                }

                // ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    document.getElementById('cameraBtn').classList.add('disabled');
                }

                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½
                if (!navigator.clipboard || !navigator.clipboard.write) {
                    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®è²¼ã‚Šä»˜ã‘ã¯åˆ¥ã®æ–¹æ³•ã§ã‚‚å¯èƒ½ãªã®ã§ç„¡åŠ¹åŒ–ã—ãªã„
                }
            },

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners() {
                // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒœã‚¿ãƒ³
                document.getElementById('screenshotBtn').addEventListener('click', () => this.captureScreen());

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                document.getElementById('uploadBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileUpload(e.target.files[0]);
                    }
                });

                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®è²¼ã‚Šä»˜ã‘
                document.getElementById('pasteBtn').addEventListener('click', async () => {
                    try {
                        const clipboardItems = await navigator.clipboard.read();
                        for (const item of clipboardItems) {
                            for (const type of item.types) {
                                if (type.startsWith('image/')) {
                                    const blob = await item.getType(type);
                                    this.handleImageBlob(blob);
                                    return;
                                }
                            }
                        }
                        this.showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
                    } catch (err) {
                        this.showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
                    }
                });

                // ãƒšãƒ¼ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆï¼ˆCtrl+Vï¼‰
                document.addEventListener('paste', (e) => {
                    if (this.state !== 'initial') return;

                    const items = e.clipboardData.items;
                    for (let item of items) {
                        if (item.type.startsWith('image/')) {
                            const blob = item.getAsFile();
                            this.handleImageBlob(blob);
                            break;
                        }
                    }
                });

                // ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³
                document.getElementById('cameraBtn').addEventListener('click', () => this.captureCamera());

                // ãƒˆãƒªãƒŸãƒ³ã‚°ç”»é¢ã®ãƒœã‚¿ãƒ³
                document.getElementById('cropConfirmBtn').addEventListener('click', () => this.confirmCrop());
                document.getElementById('cropCancelBtn').addEventListener('click', () => this.cancelCrop());

                // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãƒœã‚¿ãƒ³
                document.querySelectorAll('.aspect-button').forEach(btn => {
                    btn.addEventListener('click', (e) => this.changeAspectRatio(e.target));
                });

                // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”»é¢ã®ãƒœã‚¿ãƒ³
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadImage());
                document.getElementById('clipboardBtn').addEventListener('click', () => this.copyToClipboard());
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
            },

            // ç”»é¢é·ç§»
            changeState(newState) {
                this.state = newState;

                // å…¨ç”»é¢ã‚’éè¡¨ç¤º
                document.getElementById('initialScreen').style.display = 'none';
                document.getElementById('croppingScreen').style.display = 'none';
                document.getElementById('exportScreen').style.display = 'none';

                // å¯¾è±¡ã®ç”»é¢ã‚’è¡¨ç¤º
                switch (newState) {
                    case 'initial':
                        document.getElementById('initialScreen').style.display = 'flex';
                        break;
                    case 'cropping':
                        document.getElementById('croppingScreen').style.display = 'block';
                        break;
                    case 'export':
                        document.getElementById('exportScreen').style.display = 'block';
                        break;
                }
            },

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            showLoading() {
                document.getElementById('loading').style.display = 'flex';
            },

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            },

            // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            },

            // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£
            async captureScreen() {
                try {
                    this.showLoading();

                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: false
                    });

                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();

                    video.onloadedmetadata = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');

                        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ’®å½±
                        setTimeout(() => {
                            ctx.drawImage(video, 0, 0);
                            stream.getTracks().forEach(track => track.stop());

                            canvas.toBlob((blob) => {
                                this.hideLoading();
                                this.handleImageBlob(blob);
                            });
                        }, 100);
                    };
                } catch (err) {
                    this.hideLoading();
                    if (err.name === 'NotAllowedError') {
                        this.showToast('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
                    } else {
                        this.showToast('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },

            // ã‚«ãƒ¡ãƒ©ã‚­ãƒ£ãƒ—ãƒãƒ£
            async captureCamera() {
                try {
                    this.showLoading();

                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });

                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();

                    // ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
                    const captureBtn = document.createElement('button');
                    captureBtn.textContent = 'æ’®å½±';
                    captureBtn.style.cssText = 'position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1001; padding: 15px 30px; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 50px; cursor: pointer;';

                    video.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1000;';
                    document.body.appendChild(video);
                    document.body.appendChild(captureBtn);

                    this.hideLoading();

                    captureBtn.onclick = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0);

                        stream.getTracks().forEach(track => track.stop());
                        document.body.removeChild(video);
                        document.body.removeChild(captureBtn);

                        canvas.toBlob((blob) => {
                            this.handleImageBlob(blob);
                        });
                    };
                } catch (err) {
                    this.hideLoading();
                    this.showToast('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
                }
            },

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            handleFileUpload(file) {
                if (!file.type.startsWith('image/')) {
                    this.showToast('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                this.showLoading();
                const reader = new FileReader();

                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.hideLoading();
                        this.currentImage = img;
                        this.showCroppingScreen();
                    };
                    img.src = e.target.result;
                };

                reader.readAsDataURL(file);
            },

            // ç”»åƒBlobã®å‡¦ç†
            handleImageBlob(blob) {
                this.showLoading();
                const url = URL.createObjectURL(blob);
                const img = new Image();

                img.onload = () => {
                    this.hideLoading();
                    this.currentImage = img;
                    this.showCroppingScreen();
                };

                img.src = url;
            },

            // ãƒˆãƒªãƒŸãƒ³ã‚°ç”»é¢ã®è¡¨ç¤º
            showCroppingScreen() {
                this.changeState('cropping');

                const croppingImage = document.getElementById('croppingImage');
                
                // ç”»åƒãŒæ—¢ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹Imageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
                if (this.currentImage instanceof HTMLImageElement) {
                    // srcãŒãªã„å ´åˆã¯ã€canvasã‚’ä½¿ã£ã¦ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    if (!this.currentImage.src || this.currentImage.src.startsWith('blob:')) {
                        const canvas = document.createElement('canvas');
                        canvas.width = this.currentImage.width;
                        canvas.height = this.currentImage.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(this.currentImage, 0, 0);
                        croppingImage.src = canvas.toDataURL('image/png');
                    } else {
                        croppingImage.src = this.currentImage.src;
                    }
                }

                // Cropper.jsã®åˆæœŸåŒ–ã¯ç”»åƒãŒå®Œå…¨ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã‹ã‚‰
                croppingImage.onload = () => {
                    // Cropper.jsã®åˆæœŸåŒ–
                    if (this.cropper) {
                        this.cropper.destroy();
                    }

                    this.cropper = new Cropper(croppingImage, {
                        aspectRatio: NaN,
                        viewMode: 1,
                        minCropBoxWidth: 50,
                        minCropBoxHeight: 50,
                        responsive: true,
                        restore: true,
                        center: true,
                        highlight: true,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                    });
                };
            },

            // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã®å¤‰æ›´
            changeAspectRatio(button) {
                document.querySelectorAll('.aspect-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');

                const ratio = parseFloat(button.dataset.ratio);
                this.cropper.setAspectRatio(ratio);
            },

            // ãƒˆãƒªãƒŸãƒ³ã‚°ã®ç¢ºå®š
            confirmCrop() {
                this.showLoading();

                this.croppedCanvas = this.cropper.getCroppedCanvas();

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®è¨­å®š
                this.croppedCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    document.getElementById('previewImage').src = url;
                    this.hideLoading();
                    this.changeState('export');
                });
            },

            // ãƒˆãƒªãƒŸãƒ³ã‚°ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            cancelCrop() {
                if (this.cropper) {
                    this.cropper.destroy();
                    this.cropper = null;
                }
                this.changeState('initial');
            },

            // ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            downloadImage() {
                this.croppedCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cropped-image-${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showToast('ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                }, 'image/png');
            },

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼
            async copyToClipboard() {
                try {
                    this.croppedCanvas.toBlob(async (blob) => {
                        await navigator.clipboard.write([
                            new ClipboardItem({ [blob.type]: blob })
                        ]);
                        this.showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    }, 'image/png');
                } catch (err) {
                    this.showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            },

            // ãƒªã‚»ãƒƒãƒˆ
            reset() {
                if (this.cropper) {
                    this.cropper.destroy();
                    this.cropper = null;
                }
                this.currentImage = null;
                this.croppedCanvas = null;
                document.getElementById('fileInput').value = '';
                this.changeState('initial');
            }
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>

</html>